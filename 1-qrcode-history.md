# 小程序扫普通二维码调起小程序bug:码地址传递错误，传为历史地址

## 作者： [陈小二](https://github.com/chenyaoswu)

### 问题：
用户扫码二维码A，小程序onload中传递q参数为二维码地址B，且该二维码地址为用户历史使用二维码地址。

### 原因： 
微信侧扫码启动参数错乱。

    用户使用微信“扫一扫”扫描二维码A，微信通过系统事件启动小程序，用户使用完之后，将小程序退到后台，一段时间后小程序被系统回收。
    用户再次扫描二维码B，微信仍然通过系统事件启动小程序，但是实际上，系统先发出A二维码的启动事件，再发出B二维码的启动事件，
    导致小程序启动参数错乱。理论上，用户第二次扫码的时候，系统不应该连续发出两次事件。

### 解决方案：
方案一（覆盖7-8成用户）:

微信侧目前上线了热修复方案，纠正该问题，保证通过系统事件启动时传递正确的码地址。但目前该方案仅能覆盖最近两个版本，即6.5.20以后的，覆盖人群不会很高，活跃用户的七八成。所以仍然存在该bug.

方案2 (解决剩下的2-3成用户)：

目前扫码启动小程序的场景，微信会将原始URL通过参数的方式传给小程序，key为"q"。
后台改动上线后，会多出一个key为"scancode_time"的UNIX时间戳参数，是用户扫码的时间。
用户扫码时间和执行onlaod的时间相对比如果在30s以内，可以认为传递给我们的码地址是30s以内刚扫过的码，可以认为传递的非历史地址。从这个逻辑出发，做了一下校验：

![传错码地址校验](https://github.com/find-xcx-bugs/xcx-bugs-list/blob/master/images/1-way.png)

ps:第二次将扫码时间与服务器端时间再次进行校验的目的：避免部分用户手动更改手机时间或者本地手机时间差距较大，导致问题出现，故再进行一次服务端时间校验。


